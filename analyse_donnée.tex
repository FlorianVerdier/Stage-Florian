\documentclass[12pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[french]{babel}
\usepackage[T1]{fontenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{pgf-pie}  
\usepackage{bbm}

\usepackage{tikz}
\usetikzlibrary{babel}
\usetikzlibrary{patterns}
\usetikzlibrary{decorations.markings}
\usepackage{pgfplots}
\usetikzlibrary{arrows,calc}
\usepgfplotslibrary{dateplot}
\pgfplotsset{compat=1.17}

\author{Florian VERDIER}


\newcommand{\E}[1]{\mathbb{E}\left[ #1 \right]}
\newcommand{\R}{\mathbb{R}}
\newcommand{\1}[1]{\mathbbm{1}_{\{#1\}} }

\newtheorem{theorem}{Theorem}
\theoremstyle{definition}
\newtheorem{definition}{Definition}
\renewcommand{\thefigure}{\arabic{figure}}

\begin{document}

\section{Présentation du service étudié}
\subsection{Principe général de Communauto}
Communauto est un service basé dans différentes villes, principalement au Canada mais également à Paris, qui propose de la location de voitures sous deux formules :
\begin{description}
\item[free-floating:] les utilisateurs peuvent utiliser une voiture garée dans l'espace public afin d'effectuer un trajet d'un point A à un point B, tout en restant dans la zone de service de Communauto. Cette formule est principalement destinée aux trajets quotidiens, par exemple entre le domicile et le lieu de travail.
\item[basé-station:] les utilisateurs peuvent utiliser une voiture garée dans l'une des nombreuses stations réparties dans la ville afin d'effectuer un trajet puis de ramener la voiture à la station de départ. Cette formule est plus destinée aux plus long trajets, planifiés à l'avance, par exemple dans le cadre de voyages sur le week-end. 
\end{description}

Ces deux systèmes partagent un même abonnement ainsi qu'un tarif identique après 4 heures d'utilisation, ce qui permet des interactions entre ces deux systèmes, par le report d'usager d'un système à l'autre en fonction de la disponibilité.

\subsection{Fonctionnement du système et lexique utilisé}

Les utilisateurs ont accès à une application sur lesquelles ils peuvent réserver une voiture. Le moment où un usager réserve une voiture est appelé \emph{temps d'inscription}.

Pour les deux systèmes, on peut séparer le temps entre l'inscription d'une réservation et sa fin en deux: Le temps s'écoulant entre l'inscription et le début de la réservation est appelé \emph{temps de pré-réservation}, le \emph{temps de réservation} (et non temps de trajet) correspond lui à la durée de réservation elle-même.

\begin{figure}[h]
\centering
\begin{tikzpicture}

\draw[->] (0,0) -- (8,0);
\draw (1,-0.2) -- (1,0.2) node[midway,below] {\tiny{Arrivée de l'usager}};
\draw (5,-0.2) -- (5,0.2) node[midway,below] {\tiny{Début de la}}  node[very near start,below] {\tiny{réservation}};
\draw (7,-0.2) -- (7,0.2) node[midway,below] {\tiny{Fin de la}}node[very near start,below] {\tiny{réservation}};
\draw[<->,dashed] (1.1,0.25) -- (4.9,0.25) node[midway,above] {\tiny{Pré-réservation}};
\draw[<->,dashed] (5.1,0.25) -- (6.9,0.25) node[midway,above] {\tiny{Réservation}};
\end{tikzpicture}
\caption{Schéma d'une réservation}
\end{figure}


\subsubsection{Système free-floating}

Dans ce système, les usagers peuvent sélectionner une voiture disponible et la réserver. Une voiture réservée l'est alors pendant 30 minutes, temps pendant lequel le client peut se rendre à la voiture et la prendre. La réservation est automatiquement annulée au bout de 30 minutes si le client ne s'est pas présenté. Une fois la voiture récupérée, l'usager peut la garder aussi longtemps qu'il le souhaite avant de la libérer.

Le temps de pré-réservation est ainsi inférieur à 30 minutes.

\subsection{Système basé-stations}

Dans ce système, les usagers se connectant à un certain instant peuvent sélectionner une voiture assignée à une station et réserver un créneau futur s'il est disponible. La réservation peut s'effectuer jusqu'à un mois à l'avance.

Il est également possible pour un usager d'annuler une réservation effectuée ou encore de rendre la voiture avant la fin annoncée de la réservation. Dans ce dernier cas, on parlera de \emph{fin de réservation anticipée} par opposition aux \emph{réservations menées à leur termes}.

Le temps de pré-réservation peut ainsi monter à 1 mois tandis que la durée de réservation, à la différence du free-floating, est défini dès le début même s'il peut être modifié par la suite.






\section{Analyse de données}
\subsection{Présentation des données}

Grâce à un partenariat entre Communauto et Polytechnique Montréal, j'ai eu accès aux données correspondant aux réservations de voitures effectuées dans la ville de Montréal. 
J'ai ainsi pu étudier les données de l'année 2021, comprenant  aussi bien les réservations effectuées sur les voitures en free-floating que sur celles en basés-stations, cela correspondant à respectivement à 69\% et 31\% des réservations effectués.


Le système est basé sur plus de 2000 voitures, dont environ 40\% sont en free-floating tandis que 60\% sont des voitures basées-station réparties en près de 500 stations réparties dans la ville.

Je disposais pour ces données d'un grand nombre de champs dont ceux que j'ai principalement utilisés sont les suivant:
\begin{itemize}
\item la date et l'heure de début et de fin de la réservation
\item la distance effectuée durant la réservation
\item les points de départ et d'arrivée de la réservation. Cela correspond à la localisation de la station pour les basées-station
\item l'adresse approximative des usagers
\item lorsque la réservation est annulée, la date d'annulation
\item le statut de la réservation, parmi active, finie prématurément, annulée ou modifiée entre autres
\end{itemize}

On retrouve dans les données principalement des réservations {actives (menées à leur terme), annulées ou finies prématurément ainsi qu'un très petit nombre de réservations au statut spécial car effectuées par Communauto pour maintenance. Leur répartition est présentée figure~\ref{Répartition}.

\begin{figure}[!h]
\centering
\begin{tikzpicture}[scale = 0.6]

\pie[
    color = {
        yellow!90!black,
        green!60!black,
        blue!60,
        red!70,
    }, 
    explode = 0.1
]{46.7/Finies prématurément,
    28.7/Menées à leur terme,
    24/Annulées,
    0.6/Autre
}

\end{tikzpicture}
\caption{Répartition des statuts des réservations basées-stations en 2021}
\label{Répartition}
\end{figure}
 	
 	
\subsection{Nettoyage préalable des  données}
Pour étudier les données et tenter de déterminer les lois de probabilités par lesquelles on peut approximer les différentes distribution, il faut commencer par nettoyer et filtrer les données:

Dans un premier temps, il s'agit ainsi d'isoler les réservations réelles, c'est à dire les réservations effectuées par les usagers e, et d'éliminer les autres, par exemple les réservations pour maintenance ou pour changer la voiture de station de rattachement, ainsi que des restes de réservations annulées, qu'en peut identifier par une distance parcourue nulle et un tarif appliqué nul  .
	

Suivant le paramètre étudié, j'ai pu avoir à filtrer selon le statut de la réservation, afin d'éliminer les trajets annulés pour mesurer le temps de réservation effectif par exemple.



\subsection{Fluctuations au cours du temps de la capacité utilisée}


Je me suis intéressé au comportement des usagers, pour voir notamment quelles périodes sont les plus prisées par les usagers.

La figure~\ref{Année_sbcs} présente le nombre de voitures réservées tout au long de l'année afin d'avoir un premier aperçu des périodes pendant lesquelles les voitures basées-stations sont les plus utilisées. 

\begin{figure}[!h]
\centering
\begin{tikzpicture}
       \begin{axis}[
%unit vector ratio=1 45,
date coordinates in=x,
date ZERO= 2021-01-04,
xticklabel = {\day.\month},
xmin={2021-01-01}, ymin=0, xmax={2021-12-31}, ymax=1.1,
ylabel={Nombre de voiture réservées (normalisé)},
ylabel style={xshift=+9pt},
xlabel={Jours},
xlabel style={xshift=+9pt},
width=1\linewidth,height=0.4\linewidth,
grid=major,
]
\addplot[blue, line width=0.001pt, smooth] table[col sep=comma,trim cells=true,y=y]{graphs/evolution_annee.txt};
\end{axis}
\end{tikzpicture}
\caption{Occupation du système au cours de l'année 2021}
\label{Année_sbcs}
\end{figure}

Ce graphe permet d'identifier les périodes les plus importantes, qui sont par ordre décroissant les vacances d'été et de noël, où le minimum de réservation à un instant donné est particulièrement élevé, les autres vacances et weekends prolongés puis les week-ends.

Ce graphe ne prend pas en compte les réservations ayant commencé avant 2021, ce qui explique le faible nombre de réservations début 2021 par rapport à 2021: il y a en réalité un grand nombre de longues réservations commençant fin 2020 qui n'apparaissent par sur ces données.


La figure~\ref{semaine_type} présente la capacité utilisée typique durant une semaine, obtenue en moyennant chaque jour de la semaine sur les 53 semaines de l'année 2021 et qui permet de voir plus finement ce qui se passe au cours d'une semaine.


\begin{figure}[!h]
\centering
\begin{tikzpicture}[scale=0.4]
       \begin{axis}[
date coordinates in=x,
date ZERO= 2021-01-04,
xticklabel = {\day.\month},
xmin={2021-01-04}, ymin=0, xmax={2021-01-11}, ymax=1,
ylabel={Nombre de voiture occupées (normalisé)},
ylabel style={xshift=+9pt},
%xlabel={},
xlabel style={xshift=+9pt},
x tick label style={xshift=2.2em},
width=\linewidth,height=\linewidth,
grid=major,
xtick={2021-01-04 ,2021-01-05,2021-01-06 ,2021-01-07,2021-01-08,2021-01-09,2021-01-10},
xticklabels={Lundi, Mardi,Mercredi,Jeudi,Vendredi,Samedi,Dimanche }
]
\addplot[blue, thick, smooth] table[col sep=comma,trim cells=true,y=y]{graphs/semaine_type.txt};
\end{axis}
\end{tikzpicture}
\caption{Occupation du système au cours d'une semaine type}
\label{semaine_type}
\end{figure}

On y observe ainsi de grandes fluctuations de l'occupation au cours de la semaine, principalement à l'échelle de la journée avec des pics chaque jour aux alentours de 13h et des périodes de creux durant les nuits.
Cette unicité du pic est intéressante car c'est un comportement différent des voitures de free-floating, présentant un pic d'utilisation en matinée et en soirée (figure à tracer), 

Par ailleurs un effet dû aux weekends est très clairement présent, tout d'abord avec des pics en journée plus hauts que durant le reste de la semaine mais aussi avec des creux plus élevés, représentant les usagers qui réservent une voiture afin de partir en week-end avec. Par ailleurs, on remarque que le vendredi fait en quelque sorte la transition entre la semaine et le week-end, avec un pic intermédiaire en milieu de journée et un creux de nuit entre vendredi et samedi plus chargée que les nuits de semaine, ce qui montre que les départs en weekends peuvent commencer dès le vendredi.






\subsection{Étude du temps de réservation des usagers}


\subsubsection{Premières analyses}

On mesure un temps de réservation moyen de 7.8h alors que le maximum de la distribution est situé à 2h et le temps médian est lui de 3.5. La moyenne du temps de réservation est en effet fortement augmentée par la présence de très longues réservations, 1\% des réservations durant notamment plus de 2 semaines, soit plus de 300h.

De plus le kurtosis de cette distribution vaut 160, ce qui indique que l'on a affaire à une distribution à queue lourde, c'est à dire qu'elle possède une queue plus épaisse qu'une loi normale et donc que les événements extrêmes y sont plus probables.



\subsubsection{Détermination et lissage de la distribution}

Afin de déterminer des informations plus fines, il faut étudier l'allure de la distribution:
Pour cela, dans le cadre du temps de réservation des usagers, le champ \emph{res\_trip\_length\_hr} présent dans les données correspond précisément au temps de réservation de chaque élément.

Il ne comprend supposément que des temps définies au quart d'heure près, les réservations pour les voitures basés-station se faisant sur des créneaux de la taille d'un quart d'heure. Cependant, on retrouve parmi les données certaines valeurs aberrantes, telles des réservations durant 1 ou 40 minutes par exemple.  Cela correspondant à seulement 13 réservations, j'ai décidé de les enlever de l'étude du temps de réservation.

On peut alors obtenir la répartition empirique des temps de réservation (courbe bleue sur la figure~\ref{lissage_courbe}) qui reste néanmoins très irrégulière; on peut en effet observer une certaine périodicité d'ordre 4, certainement due aux utilisateurs, qui auront une plus grande tendance à réserver une durée entière en heures. Pour la même raison, on observe un pic de réservations d'une durée de 10 heures ainsi que des pics successifs présents pour tout les jours entiers.

Afin de pouvoir exploiter la courbe, il est nécessaire de lisser la courbe, par exemple avec un estimateur à noyau de fenêtre assez large pour enlever ces périodicités. J'ai préféré un estimateur à taille de noyau variable afin de ne pas trop écraser les données présentes à l'origine et ainsi de garder l'allure générale de la courbe, ce qui est réalisé sur la courbe rouge en figure~\ref{lissage_courbe}.


\begin{figure} [h]
\centering
\begin{tikzpicture}[scale=0.5]
\begin{axis}[
xmin=0, ymin=0, xmax=25, ymax=0.07,
ylabel={Densité},
ylabel style={xshift=+9pt},
xlabel={Temps de Réservation (en heure)},
xlabel style={xshift=+9pt},
width=\linewidth,height=\linewidth
]
\addplot[blue, thick, smooth]
table[x=x,y=y]{graphs/Temps_de_trajet_moins_VA.txt};;
\addplot[red, smooth]
table[x=x,y=y]{graphs/Temps_de_trajet_lisse.txt};;
\end{axis}
\end{tikzpicture}
\caption{Densité du Temps de réservation lissée}
\label{lissage_courbe}
\end{figure}


\subsubsection{Détermination de la loi la mieux adaptée aux données}

A partir de cette courbe lissée, j'ai cherché à déterminer par quelle loi l'approcher pour correspondre le mieux aux données et ainsi adapter le mieux le modèle. Pour cela, je me suis concentré sur des lois à queues lourdes, à savoir notamment loi gamma, loi log-normale, loi de Weibull ou encore loi de Burr.

Je les aies comparées à la distribution empirique du temps de réservation en utilisant la distance en variation totale:

\begin{definition}{Distance en variation totale}\\
Soient $\mu,\nu$ deux mesures de probabilité de densités respectives $f$ et $g$.\\
On note $\displaystyle d_{VT}(\mu,\nu) = \int_{\mathbb{R}}|f(x)-g(x)|dx$ la distance en variation totale entre $\mu$ et $\nu$.
\end{definition}

Après optimisation des différents paramètres pour les différentes lois, j'ai obtenu le tableau~\ref{Distance_à_temps_réservation} présentant la distance minimale entre chaque loi et la distribution du temps de réservation.

\begin{figure}[h]
\centering
\begin{tabular}{c|c}
Loi approximante & Distance\\
\hline
Loi gamma $\Gamma(0.63,70.82)$&  0.23\\
Loi Log-normale $\log-\mathcal{N}(2.62,0.9)$ & 0.17 \\
Loi de Weibull$(k =1.13  ,\lambda = 16,7)$ & 0.24\\
\end{tabular}
\caption{Distance entre différentes lois et la distribution du temps de réservation}
\label{Distance_à_temps_réservation}
\end{figure}

Grâce à cela, il s'avère que c'est une loi log-normale de paramètres $\mu = 2.6$ et $\sigma^2=0.9$ qui permet la meilleure approximation du temps de réservation.

Le choix d'une loi log-normale est confirmé par l'étude des graphes quantile-quantile des différentes distributions théoriques présents en figure~\ref{Qplot} seule la loi log-normale sélectionnée permet une bonne approximation de la queue de distribution.



\begin{figure}[h]
\label{Qplot}
\centering
\begin{tikzpicture}[scale=0.5]
\begin{axis}[
xmin=0, ymin=0, xmax=320, ymax=320,
ylabel style={xshift=+9pt},
xlabel style={xshift=+9pt},
width=\linewidth,height=\linewidth
]


\addplot[red, smooth, only marks ]
table[x=x,y=y]{graphs/Qplot_log_normal.txt};
\addlegendentry{Loi log-normale}
\addplot[green, smooth, only marks ]
table[x=x,y=y]{graphs/Qplot_gamma.txt};
\addlegendentry{Loi Gamma}
\addplot[yellow, smooth, only marks ]
table[x=x,y=y]{graphs/Qplot_weibull.txt};
\addlegendentry{Loi Weibull}
\addplot[blue, smooth]
table[x=x,y=x]{graphs/Qplot_log_normal.txt};
\end{axis}
\end{tikzpicture}
\caption{QQPlot}
\end{figure}

\begin{definition}{Loi log-normale}\\
Une variable aléatoire $X$ suit une loi log normale de paramètres $\mu$ et $\sigma^2$ lorsque $Y = \ln(X)$ suit une suit une loi normale de paramètres $\mu$ et $\sigma^2$.
\end{definition}


\begin{figure}[!h]
\centering
\begin{tikzpicture}[scale=0.5]
\begin{axis}[
xmin=0, ymin=0, xmax=25, ymax=0.07,
ylabel={Densité},
ylabel style={xshift=+9pt},
xlabel={Temps de Réservation (en heure)},
xlabel style={xshift=+9pt},
width=\linewidth,height=\linewidth
]

\addplot[blue, smooth]
table[x=x,y=y]{graphs/Temps_de_trajet_lisse.txt};;
\addlegendentry{Données réelles lissées};
\addplot[red, smooth]
table[x=x,y=log_normal]{graphs/Temps_de_trajet_ajustement_lois.txt};
\addlegendentry{Loi log-normale};
\end{axis}
\end{tikzpicture}
\caption{Ajustement du temps de réservation par loi log-normale}
\end{figure}

\subsection{Étude des stations}

\subsubsection{Capacité des stations}
Dans le cadre de cette étude, il est intéressant de regarder la capacité des stations dans lesquelles sont stationnées les voitures basées-stations ainsi que leur répartition dans la ville.

Pour cela, j'ai regardé les voitures en activité et leur station lorsque le maximum de voitures étaient utilisées, à savoir le 24 juillet à 15h30, avec un pics à plus de 1300 voitures réservées en même temps. J'ai procédé ainsi afin de ne pas avoir des doublons dans les données, dues aux éventuelles voitures changeant de stations au gré des ajustements réalisées par Communauto.

Les graphes suivants se basent donc sur l'hypothèse que toutes les voitures étaient réservées à ce moment là, ce qui est assez proche de la réalité car trouver une voiture le week-end, et à fortiori durant la période estivale, est très difficile.
Les graphes permettent d'avoir un aperçu du système au maximum de sa capacité.


\begin{figure}[!h]
\centering
\begin{tikzpicture}[scale=0.4]
       \begin{axis}[
xmin=0, ymin=0, xmax=30, ymax=170,
ylabel={Capacité de la station},
ylabel style={xshift=+9pt},
xlabel={Taille de la station},
xlabel style={xshift=+9pt},
width=\linewidth,height=\linewidth
]
\addplot[blue, thick, smooth,hist={bins = 30,data min = 0.5,data max = 30.5}] file{graphs/distribution_nb_voitures_par_station.txt};
\end{axis}
\end{tikzpicture}
\caption{Distribution du nombre de voitures par station}
\label{hist_capa}
\end{figure}


En traçant l'histogramme de la capacité(Figure~ \ref{hist_capa}), on observe une majorité de très petites stations: 66\% des stations ayant 1 ou 2 voitures seulement. C'est explicable par la politique de Communauto d'avoir des station au plus près des usagers, multipliant ainsi la quantité de stations déployées, ainsi que par la difficulté d'obtenir des zones afin d'y réaliser de grandes stations.
Il y a cependant quelques grandes stations, 5\% des stations ayant plus de 10 voitures et elles représentent ainsi plus du quart des voitures basées-stations en circulation.

\subsubsection{Localisation des stations}

La figure(à ajouter) présent toutes les stations de communauto présentes à Montréal.

\subsection{Étude de la distance de trajet}


Afin d'étudier la loi de la distance parcourue, il faut dans un premier temps retirer des données les réservations ayant une distance parcourue nulle, correspondant la majorité du temps à des réservations "à vide", sans bouger la voiture. (Cela pourrait également correspondre à de très petits trajets, la distance relevée étant arrondie au kilomètre prés, mais cela ne concerne qu'un faible nombre de trajets). Ces réservations correspondent à 10\% du total des réservations

L'étude de la distance est après cela tout à fait similaire à celle de du temps de trajet et la distribution qui l'approche le mieux est pareillement une loi log-normale, dont les paramètres sont cette fois $\mu = 3.08 $, $\sigma^2$ = 1.25. La Figure~\ref{Ajustement_distance} présente la loi expérimentale et la loi approchée en superposition.

\begin{figure}[!h]
\centering
\begin{tikzpicture}[scale=0.5]
\begin{axis}[
xmin=0, ymin=0, xmax=100, ymax=0.04,
ylabel={Densité},
ylabel style={xshift=+9pt},
xlabel={Distance parcourure (en km)},
xlabel style={xshift=+9pt},
width=\linewidth,height=\linewidth
]

\addplot[blue, smooth]table[x=x,y=y]{graphs/Distance_de_trajet_lisse.txt};
\addlegendentry{Données réelles lissées};
\addplot[red, smooth]table[x=x,y=log_normal]{graphs/Distance_de_trajet_ajustement_log_normal.txt};
\addlegendentry{Loi log-normale};
\end{axis}
\end{tikzpicture}
\caption{Ajustement de la distance parcourue par une loi log-normale}
\label{Ajustement_distance}
\end{figure}

\subsection{Corrélation entre le temps de réservation et la distance parcourue pour obtenir une voiture}

Il est que les usagers sont souvent près à traverser la ville afin d'obtenir une voiture. J'ai donc voulu vérifier cela en traçant la distribution de la distance entre la station utilisée et le domicile des usagers pour différents taux d'occupation du système.
\subsection{Étude du temps d'annulation}



Une autre donnée intéressante concerne l'annulation des réservations. En effet, comme montré par la figure~\ref{Répartition} cela correspond à une grande part des données: 24\% des réservations initiales étant annulées. 

Il est alors intéressant de regarder quand cette annulation a lieu dans le cycle de vie de la réservation. Pour cela, on peut s'intéresser à la loi du temps s'écoulant entre l'annulation de la réservation et son début théorique. La loi empirique est tracée figure~\ref{délai_annulation_début} 

\begin{figure}[!h]
\centering
\begin{tikzpicture}[scale=0.5]
\begin{axis}[
xmin=-1, ymin=0, xmax=10, ymax=0.2,
ylabel={Densité},
ylabel style={xshift=+9pt},
xlabel={Temps (en jours)},
xlabel style={xshift=+9pt},
width=\linewidth,height=\linewidth
]
\addplot[blue, thick, smooth]
table[x=x,y=y]{graphs/Temps_annulation.txt};;
\end{axis}
\end{tikzpicture}
\caption{Densité du temps entre annulation et début de la réservation}
\label{délai_annulation_début}
\end{figure}


La première chose que l'on remarque est la présence d'un petit nombre de réservations annulées après leur temps de début de réservation, correspondant à environ 0.5\% des trajets annulés. Ceci n'est pas une erreur des données, la réservation étant payée par les usagers pour le temps écoulée.

Ensuite la majorité des annulations ont lieu juste avant le début du trajet, comme montré par le pic observées sure les données en 0. Ainsi, les réservations annulées le sont en moyenne moins de 3 jours avant le début de la réservation: 62\% étant annulées moins de 24h à l'avance.

Enfin, en regardant au temps long sur la figure~\ref{délai_annulation_jours}, un léger pic apparaît à 31 jours, représentant les clients annulant leur réservations juste après l'avoir réservée.


\begin{figure}[!h]
\centering
\begin{tikzpicture}[scale=0.4]
\begin{semilogyaxis}[
xmin=0.5, ymin=0, xmax=31, ymax=0.6,
ylabel={Nombre de réservations},
ylabel style={xshift=+9pt},
xlabel={Temps (en jours)},
xlabel style={xshift=+9pt},
width=\linewidth,height=\linewidth
]
\addplot[blue, thick, smooth]
table[x=x,y=y]{graphs/Temps_annulation_j.txt};;
\end{semilogyaxis}
\end{tikzpicture}
\caption{Densité du temps entre annulation et début de la réservation}
\label{délai_annulation_jours}
\end{figure}

\subsection{Étude du temps de pré-réservation}

Les données disposent d'un champ \emph{date d'inscription} correspondant en théorie à la date à laquelle une réservation à été inscrite dans le système, c'est à dire la date à laquelle l'usager à réservé un créneau. Cependant, cette date ne correspond généralement pas à la date d'inscription réelle mais à la date de dernière action sur la réservation, que ce soit son annulation, sa modification ou bien un retour anticipé de la voiture. Ainsi les données présentant leur  date d'inscription initiale sont très partielles et difficiles à identifier.

\section{Simulations numériques}

Afin de modéliser l'évolution 


Dans le cadre du modèle utilisé, on nécessite 5 lois afin de simuler le système:
\begin{itemize}
\item la loi du temps d'arrivée des usagers.
\item la loi du temps de pré-réservation
\item la loi du temps de réservation
\item la loi du temps d'annulation de la réservation (le temps entre l'inscription et l'annulation de la réservation)
\item la loi du temps de de retour anticipé du véhicule
\end{itemize}

Le point crucial consiste à déterminer sous quelles conditions une réservation demandée par un usager est acceptée ou non.  Le critère simple est qu'une réservation est acceptée si, sur l'intervalle voulu par l'usager, la capacité résiduelle due aux réservations précédente est toujours strictement positive.

En effet, étant donné qu'on considère un système où le client ne réserve pas une voiture spécifique mais une voiture d'une station, la condition assure qu'au moins une voiture ne sera pas encore utilisée au moment du début de la réservation de chaque client, voiture qui pourra ainsi être prise par le client.


\subsection{Le modèle du "Tetris"}

Afin de visualiser cette condition d'acceptabilité des réservations, on peut représenter les réservations successives comme des pièces d'une certaine longueur proportionnelle à la longueur du créneau réservé. On peut alors représenter les réservations successives comme différentes pièces tombant dans une grille de tetris infinie, l'axe des abscisses représentant l'axe temporel.
Chaque réservation descend alors sur l'intervalle que  le client souhaite réserver et la réservation est acceptée uniquement si ce bloc peut se retrouver en totalité en dessous de la capacité du système.

Cela est schématisé par la figure~\ref{Tetris}, présentant une capacité maximale de 4.  


\begin{figure}[h]
\centering
\begin{tikzpicture}

\draw (0,0) -- (0,6);
\draw[->] (-1,0) -- (11,0) node[very near end,below]{\tiny{Temps}} ;
\draw (10,0) -- (10,6);
\draw[dashed] (0,4) -- (10,4)  node[pos = -0.02, above left] {\tiny{Capacité}}node[pos = 0, below left] {\tiny{du système}};

\draw[pattern=vertical lines, pattern color=gray] (1,0) rectangle (5,1);
\draw[pattern=horizontal lines, pattern color=gray] (6,0) rectangle (10,1);
\draw[pattern = crosshatch dots gray
] (0,0) rectangle (1,1);
\draw[pattern = crosshatch dots gray
] (1,1) rectangle (4,2);
\draw[pattern = north west lines 
] (2,2) rectangle (4,3);
\draw[pattern = north west lines 
] (4,1) rectangle (5,2);
\draw[pattern = north west lines 
] (5,0) rectangle (6,1);
\draw[pattern = north west lines 
] (6,1) rectangle (10,2);
\draw[pattern = north east lines, pattern color=blue
] (2,3) rectangle (4,4);
\draw[pattern = north east lines, pattern color=blue 
] (4,2) rectangle (5,3);

\fill[red!60] (0,4.5) rectangle (3,5.5);
\draw (0,4.5) rectangle (3,5.5);
\node at (1.5,5.2) {\scriptsize{Réservation}};
\node at (1.5,4.8) {\scriptsize{impossible}};
\fill[green!60] (5,4.5) rectangle (8,5.5);
\draw (5,4.5) rectangle (8,5.5);
\node at (6.5,5.2) {\scriptsize{Réservation}};
\node at (6.5,4.8) {\scriptsize{possible}};


\end{tikzpicture}
\caption{Schéma représentant la condition d'acceptabilité d'une réservation}
\label{Tetris}
\end{figure}

\subsection{Modélisation mathématique}

On considère pour l'instant un modèle simplifié  où les usagers réservent à l'avance un créneau dans le futur et ne peuvent ni l'annuler ni le finir prématurément. Par ailleurs, comme dans les simulations, on considère que les usagers réservent un créneau et pas directement une voiture.

\begin{definition}{Représentation des réservations}

Les tentatives de réservations peuvent être représentée par un processus de poisson marqué sur $\R_+^3$ $(t_n,p_n,\sigma_n)$ avec :
\begin{itemize}
\item $t_n$ est le moment de l'inscription de la réservation, suivant un processus de point de Poisson, de paramètre $\lambda$
\item $p_n$ est la durée de pré-réservation de la réservation. Les $p_n$ sont i.i.d 
\item $\sigma_n$ est la durée de réservation de la réservation
\end{itemize}


La suite $(p_n,\sigma_n)$ est i.i.d et $(t_n)$ et $(p_n,\sigma_n)$ sont indépendantes. Notons $(p,\sigma)$ un couple de variables aléatoires ayant même loi que les  $(p_n,\sigma_n)$

On ajoute à ce triplet un 4-ème nombre,$\epsilon_n$, qui va correspondre à la validation de la réservation et vaut 1 si cette réservation ne rentre pas en conflit avec les réservations précédentes au moment de l'inscription.
\end{definition}

\begin{definition}{Capacité réservée}

La capacité réservée à un instant donné correspond au nombre de véhicules réservés à cet instant, en prenant en compte l'ensemble des réservations validées.

Elle vaut
\begin{equation}
C(t) = \sum_{n=0}^{\infty} \epsilon_n \mathbbm{1}_{\{t_n+p_n<t<t_n+p_n+\sigma_n\}}
\end{equation}

\end{definition}



\begin{definition}{Capacité prévue}

La capacité prévue en $t$ depuis l'instant $t^{*}$ correspond à la prévision de la capacité en $t_1$ à partir des informations disponibles en $t_0$, c'est à dire sans tenir compte des inscriptions ultérieures à $t^*$.

Elle vaut alors
\begin{equation}
C(t|t^{*}) = \sum_{n=0}^{\infty} \epsilon_n\,\1{t_n<t^*}\mathbbm{1}_{\{t_n+p_n<t<t_n+p_n+\sigma_n,\}}
\end{equation}

\end{definition}


\begin{theorem}{Acceptation des réservations}

La condition d'acceptabilité de la n-ième réservation se traduit par
\begin{equation}
\forall t \in [t_n+p_n,t_n+p_n+\sigma_n]\,\,\,\, C(t|t_n) < C_{\max}
\end{equation}

L'expression de $\epsilon_n$ est alors:
\begin{equation}
\epsilon_n = \1{\underset{t \in [t_n+p_n,t_n+p_n+\sigma_n]}{\sup} C(t|t_n) < C_{\max}}
\end{equation}
\end{theorem}

\subsection{Le cas avec capacité infinie}

Dans ce cas, toutes les réservations demandées sont acceptées dans le système, ainsi le $\epsilon_n$ introduit précédemment n'a plus d'utilité.




Le nombre de voitures réservées à l'instant $t$, c'est à dire ayant fini la période de pré-réservation mais pas encore celle de réservation proprement dite vaut alors:
\begin{equation}
LCt) = \sum_{n=0}^{\infty} 	\mathbbm{1}_{\{t_n+p_n \leq t < t_n + p_n +\sigma_n\}}
\end{equation}

En notant $B_t = \{(u,x,y) \in \left(\mathbb{R}^+\right)^3  | u+x<t<u+x+y \} $ et $\mathcal{N}$ le processus de Poisson marqué d'intensité $\mu(du,dx,dy) = \lambda du \nu(dx,dy)$ représentant l'arrivée des usagers, cela donne:

\begin{equation}
L(t) = \mathcal{N}(\mathbbm{1}_{B_t})
\end{equation}



\begin{theorem} {}



\begin{equation}
\forall t\,\,\E{L(t)} = \E{\min((t-p)^+,\sigma)}	
\end{equation}

\end{theorem}

\begin{proof}
\begin{align*}
\E{L(t)} &= \E{\mathcal{N}(\mathbbm{1}_{B_t})}\\
&= \mu(\mathbbm{1}_{B_t})\\
&= \int_{(\R^+)^3} \mathbbm{1}_{B_t}(u,x,y) \mu(du,dx,dy)\\
&= \lambda \int_{(\R^+)^2} \int_{\R^+} \1{ u+x<t<u+x+y} du \nu(dx,dy)\\
&= \lambda \int_{(\R^+)^2} \int_{\R^+} \1{ u<t-x<u+y} du \nu(dx,dy)\\
&= \lambda \int_{(\R^+)^2} \int_{(t-x-y)^+}^{(t-x)^+} du \nu(dx,dy)\\
&= \lambda \int_{(\R^+)^2} \left((t-x)^+-(t-x-y)^+\right)  \nu(dx,dy)\\
&= \lambda \int_{(\R^+)^2} \min((t-x)^+,y)  \nu(dx,dy)\\
&= \E{\min((t-p)^+,\sigma)}	
\end{align*}
\end{proof}

\subsubsection{Limite fluide}
Considérons désormais un processus similaire, où le taux d'arrivé des clients $\lambda$ est remplacé par $\lambda N$. On note alors le processus $C_N(t)$, le processus d'arrivée des usagers $\mathcal{N}_N$ et on définit le processus normalisé par 
$$ \bar{C}_N(t) = \frac{C_N(t)}{N}$$


\begin{definition}{Limite fluide}

On appelle limite fluide de $(C(t)) $ la limite de $\bar{C}_N(t)$ pour N tendant vers l'infini.
\end{definition}

\begin{theorem}{Limite du processus normalisé}

Le processus renormalisé tend en loi vers $\lambda\E{\min((t-p)^+,\sigma)}$, 

\end{theorem}

\begin{proof}
\begin{align*}
C_N(t) &=  \mathcal{N}_N(B_t)\\
&= \int_{(\R^+)^3} \1{B_t}(u,x,y) \mathcal{N}_N(du,dx,dy)\\
&= \int_{(\R^+)^3} \1{B_t}(u,x,y) \left(\mathcal{N}_N(du,dx,dy)-\lambda N du \nu(dx,dy)\right)\\ &\,\,\,+ \int_{(\R^+)^3} \1{B_t}(u,x,y) \lambda N du \nu(dx,dy)\\
\end{align*}


Notons $M_N(t) = \int_{(\R^+)^3} \1{B_t}(u,x,y) \left(\mathcal{N}_N(du,dx,dy)-\lambda N du \nu(dx,dy)\right)$ , de sorte que $C_N(t) = M_N(t) + \lambda \E{C(t)} $

\begin{lemma}
$(M_N(t))$ est une martingale de processus croissant associé $\lambda\E{C(t)}$
\end{lemma}


\end{proof}


\end{document}




\begin{defintion}
La n-ième tentative de réservation peut être définie par un 6-uplet $(t_n,p_n,\sigma_n,\theta_{1,n},\theta_{2,n},\epsilon_n$ où :
\begin{itemize}
\item $t_n$ est le moment de l'inscription de la réservation
\item $p_n$ est le temps de pré-réservation de la n-ième réservation
\item $\sigma_n$ est le temps de réservation de la n-ième réservation
\item $\theta_{1,n}$ est le temps d'annulation de la réservation.

Si $\theta_{1,n} < p_n$, alors l'usager annule sa réservation au temps $t_n+\theta_{1,n}$ et toute tentative de réservation ultérieure  ne tient pas compte de cette réservation pour déterminer si les créneaux sont disponibles.

Si $\theta_{1,n} \geq p_n$, la réservation démarre comme prévu en $t_n + p_n$

\item $\theta_{2,n}$ est le temps de rendu anticipé du véhicule.

Si $\theta_{2,n} < \sigma_n$, alors l'usager rend son véhicule au temps $t_n+p_n+\theta_{2,n}$ et toute tentative de réservation ultérieure  ne tient pas compte de cette réservation pour déterminer si les créneaux sont disponibles.

Si $\theta_{2,n} \geq \sigma_n$, alors la réservation se termine comme prévu en $t_n+p_n+\sigma_n$

\item $\epsilon_n$ va correspondre à la validation de la réservation et vaut 1 si cette réservation ne rentre pas en conflit avec les réservations précédentes au moment de l'inscription.
\end{itemize}
\end{defintion}



\begin{definition}{Capacité prévue}

La capacité prévue en $t$ à l'instant $t^{*}$ correspond à la prévision de la capacité en $t_1$ à partir des informations disponibles en $t_0$, c'est à dire sans tenir compte des inscriptions ultérieures ni des annulations et fin de réservations anticipées qui auront lieu après $t^{*}$.

Elle vaut alors
\begin{equation}
C(t,t^{*}) = %\sum_{n=0}^{\infty} \epsilon_n\,\mathbbm{1}_{\{t_n<t^{*}\}} \left( \mathbbm{1}_{\{t^{*}<t_n+\theta_{1,n},t^{*}<t_n+p_n+\theta_{2,n}\}} \,\mathbbm{1}_{\{t_n+p_n<t<t_n+p_n+\sigma_n,\}} + \mathbbm{1}_{\{t_n+\theta_{1,n}\leq t^{*},\theta_{1,n}\geq p_n,t^{*}<t_n+p_n+\theta_{2,n}\}} \,\mathbbm{1}_{\{t_n+p_n<t<t_n+p_n+\sigma_n,\}} + \mathbbm{1}_{\{t_n+\theta_{1,n}\leq t^{*},\theta_{1,n}\geq p_n,t^{*}<t_n+p_n+\theta_{2,n}\}} \,\mathbbm{1}_{\{t_n+p_n<t<t_n+p_n+\sigma_n,\}} + \right)
\end{equation}

\end{definition}